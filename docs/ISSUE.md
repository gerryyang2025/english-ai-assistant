# 问题记录

## 1. 错题本句子播放失败

**问题：** 包含单引号的句子无法播放语音。

**原因：** 在 HTML onclick 属性中直接传递包含单引号的文本，JavaScript 解析时单引号提前结束字符串，导致代码出错。

**解决：** 使用索引传递方式替代文本传递，通过全局状态存储数据，函数根据索引从数据中获取内容。

---

## 2. 语句输入时光标跳离

**问题：** 在输入框中按空格键或某些按键时，页面意外滚动。

**原因：** 输入框的 keydown 事件未阻止空格键的默认行为，同时缺少滚动位置锁定机制。

**解决：** 在 keydown 和 input 事件中调用 preventDefault() 阻止默认行为，并保存/恢复滚动位置。

**完整优化（2026-01-25）：**

1. **扩展按键阻止范围** - 新增 Home、End、PageUp、PageDown、ArrowUp、ArrowDown 键的阻止
2. **保存页面级滚动位置** - 同时保存 `window.scrollY` 和容器 `scrollTop`
3. **安全聚焦函数** - 创建 `safeFocusAndSelect()` 辅助函数，在聚焦前后恢复滚动位置
4. **处理粘贴事件** - 阻止 paste 默认行为，手动处理粘贴文本并恢复滚动位置
5. **处理 Tab 键** - 实现 Tab 键循环切换输入框功能
6. **添加焦点事件监听** - 在 focus 事件中恢复滚动位置
7. **使用 requestAnimationFrame** - 确保渲染完成后才执行聚焦操作
8. **禁用浏览器自动功能** - 添加 `autocapitalize="off"` 和 `spellcheck="false"` 属性
9. **阻止 Command/Ctrl 组合键** - 防止系统级快捷键触发滚动

---

## 3. 错句复习重复添加

**问题：** 复习错句时重复回答错误会导致同一句子被多次添加到错句列表。

**原因：** 复习功能将错句转换为练习格式时未保留原始 id，检查答案时动态生成 id，导致每次错误都产生新的标识，无法触发排重逻辑。

**解决：** 保留原始数据的唯一标识符，复习场景中复用原始标识系统。

---

## 4. iOS Chrome 语音克隆无法播放

**问题：** iPhone Chrome 浏览器音色复泡模式无法播放音频，生成后一直等待直到超时。

**原因：**
1. iOS Chrome 用户代理包含 "CriOS" 而非 "Safari"，导致检测失效
2. iOS 严格限制自动播放策略，`audio.play()` 必须在用户点击事件上下文中调用
3. 解锁函数先尝试静音音频方法，在 iOS 上必然失败并等待 2 秒超时

**解决：**
1. 添加 `isIOSChrome()` 检测 iOS Chrome
2. 修改交互流程：iOS 设备音频生成后提示用户手动点击播放
3. 优化 `unlockAudioContext()`：iOS 设备直接使用 AudioContext，跳过静音音频方法

**效果：** iOS 设备等待时间从 ~5 秒减少到 <1 秒，iOS Chrome 和 Safari 均可正常播放。
